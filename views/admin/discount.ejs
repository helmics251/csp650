<!-- include header-->
<%- include('../include/header') %>
<title>Manage Discount</title>
<style>
    th {
        font-weight: 400;
    }
</style>
</head>
<!-- end header-->
<body>
<!-- include navbar-->
<%- include('../admin/adminnavbar') %>
<!-- end navbar-->
<main>
    <section>
        <!-- table -->
        <div class="container mt-5 mb-5">
            <div class="row">
                <div class="col-md-6">
                    <h2>Manage Discount</h2>
                </div>
                <div class="col-md-6 d-flex justify-content-end">
                    <button class="btn btn-primary mb-2" id="addDiscountBtn" data-toggle="modal" data-target="#addDiscountModal"><i class="fas fa-user-plus"></i> Add Discount</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover" id="manageDiscountTable">
                    <thead class="thead-dark">
                        <tr>
                            <th>#</th>
                            <th>Discount Code</th>
                            <th>Percentage(%)</th>
                            <th>Discount Code Limit</th>
                            <th>Current Uses</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% let counter = 1; %>
                        <% discountData.forEach(discount => { %>
                        <tr>
                            <td><%= counter %></td>
                            <td><%= discount.discountCode %></td>
                            <td><%= discount.discountPercentage %></td>
                            <td><%= discount.discountLimit %></td>
                            <td><%= discount.currentUses %></td>
                            <td>
                                <button 
                                    data-toggle="modal" 
                                    data-discountcode="<%= discount.discountCode %>"
                                    data-target="#deleteModal" 
                                    class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash-alt"></i> 
                                    Delete
                                </button>
                            </td>
                        </tr>
                        <% counter++; %>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- add discount modal -->
        <div class="modal fade" id="addDiscountModal" tabindex="-1" role="dialog" aria-labelledby="addDiscountModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDiscountModalLabel">Add Discount</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form action="/discount" method="post">
                            <div class="form-group">
                                <label for="discountCode">Discount Code</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-dark"><i class="fas fa-tag text-white"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="discountCode" name="discountCode" placeholder="Enter discount code" readonly>
                                    <div class="input-group-append">
                                        <button class="btn bg-dark text-white" type="button" id="generateCodeBtn">Generate Code</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="discountPercentage">Percentage(%)</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-dark"><i class="fas fa-percent text-white"></i></span>
                                    </div>
                                    <input type="number" class="form-control" id="discountPercentage" name="discountPercentage" placeholder="Enter discount percentage">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="discountLimit">Discount Code Limit</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-dark"><i class="fas fa-sort-numeric-up text-white"></i></span>
                                    </div>
                                    <input type="number" class="form-control" id="discountLimit" name="discountLimit" placeholder="Enter discount code limit e.g., 100 uses">
                                </div>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- delete discount modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <span>Are you sure you want to delete these Records?</span>
                        <p class="text-danger"><small>This action cannot be undone.</small></p>
                        <form action="/deletediscount" method="post" class="modern-form">
                            <input type="hidden" id="admindeletediscountrecord" name="discountCode">
                    </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger text-white" id="admindeletediscount">Delete</button>
                            </div>
                        </form>
                </div>
            </div>
        </div>
    </section>
</main>
<script>
    $(document).ready(function () {
        $(".nav-link.dropdown-toggle").addClass("active");
        $("a.dropdown-item[href='/discount']").addClass("active");

        $('#discountPercentage').on('keydown', function(event) {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
            }
        });

        

        $("#generateCodeBtn").click(function () {
            let code = generateCode(10);
            $("#discountCode").val(code);
        });

        function generateCode(length) {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let code = "";

            // Using a Set to ensure unique characters
            const uniqueCharacters = new Set(characters.split(''));

            // Convert Set back to an array
            const uniqueArray = Array.from(uniqueCharacters);

            for (let i = 0; i < length; i++) {
                code += uniqueArray[Math.floor(Math.random() * uniqueArray.length)];
            }

            return code;
        }

        $('#deleteModal').on('show.bs.modal', function (event) {
            let button = $(event.relatedTarget); 
            let discountcode = button.data('discountcode'); 

            let modal = $(this);

            modal.find('#admindeletediscountrecord').val(discountcode);
            modal.find(".modal-title").text("Delete All Record For: " + discountcode); 
        });
    });
</script>
<!-- include footer-->
  <%- include('../include/_footer') %>
<!-- end footer-->